package br.senai.lab365.LABMedical.mappers;

import br.senai.lab365.LABMedical.dtos.usuario.UsuarioRequest;
import br.senai.lab365.LABMedical.dtos.usuario.UsuarioResponse;
import br.senai.lab365.LABMedical.entities.Perfil;
import br.senai.lab365.LABMedical.entities.Usuario;
import br.senai.lab365.LABMedical.mappers.UsuarioMapper;
import br.senai.lab365.LABMedical.repositories.PerfilRepository;
import br.senai.lab365.LABMedical.services.PerfilService;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.MockitoAnnotations;

import java.time.LocalDate;
import java.util.Collections;
import java.util.HashSet;
import java.util.Optional;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.Mockito.*;

class UsuarioMapperTest {

    @InjectMocks
    private UsuarioMapper usuarioMapper;

    @Mock
    private PerfilRepository perfilRepository;

    @Mock
    private PerfilService perfilService;

    @BeforeEach
    void setUp() {
        MockitoAnnotations.openMocks(this);
    }

    @Test
    void toEntity_DeveRetornarUsuarioQuandoRequestValido() {
        // Arrange
        UsuarioRequest request = new UsuarioRequest(
                "John Doe",
                "john.doe@example.com",
                LocalDate.of(1990, 1, 1),
                "12345678901",
                "123456789",
                "senha123",
                "Admin"
        );

        Perfil perfil = new Perfil(); // Cria um objeto Perfil
        perfil.setNomePerfil("Admin");

        when(perfilRepository.findByNomePerfil("Admin")).thenReturn(perfil);

        // Act
        Usuario usuario = usuarioMapper.toEntity(request);

        // Assert
        assertNotNull(usuario);
        assertEquals(request.getNome(), usuario.getNome());
        assertEquals(request.getEmail(), usuario.getEmail());
        assertEquals(request.getDataNascimento(), usuario.getDataNascimento());
        assertEquals(request.getCpf(), usuario.getCpf());
        assertEquals(request.getTelefone(), usuario.getTelefone());
        assertEquals(request.getPassword(), usuario.getPassword());
        assertEquals(1, usuario.getPerfilList().size());
        assertTrue(usuario.getPerfilList().contains(perfil));
        assertEquals("senha****", usuario.getSenhaComMascara());
    }

    @Test
    void toEntity_DeveRetornarNuloQuandoRequestNulo() {
        // Act & Assert
        assertNull(usuarioMapper.toEntity(null));
    }

    @Test
    void toResponse_DeveRetornarUsuarioResponseQuandoUsuarioValido() {
        // Arrange
        Perfil perfil = new Perfil();
        perfil.setNomePerfil("Admin");

        Usuario usuario = new Usuario(
                1L,
                "John Doe",
                "john.doe@example.com",
                LocalDate.of(1990, 1, 1),
                "12345678901",
                "123456789",
                "senha123",
                new HashSet<>(Collections.singletonList(perfil)),
                "senha****"
        );

        // Act
        UsuarioResponse response = usuarioMapper.toResponse(usuario);

        // Assert
        assertNotNull(response);
        assertEquals(usuario.getId(), response.getId());
        assertEquals(usuario.getNome(), response.getNome());
        assertEquals(usuario.
